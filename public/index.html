<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <!--styles-->
    <!--link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css"-->
    <link rel="stylesheet" href="bower_components/bootswatch-dist/css/bootstrap.css">
    <link rel="stylesheet" href="css/chat-fullpage.css">
    <!--scripts-->
    <!--script src="bower_components/angular/angular.js"></script-->
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
    <script src="bower_components/socket.io.client/dist/socket.io-1.3.5.js"></script>
    <!---->
    <script src="js/auth/token-handler.js"></script>
    <script src="js/nav-bar.js"></script>

    <title>MEAN chat</title>
</head>

<body ng-app="IndexChatPageApp">
<header>
    <!--navigation bar-->
    <div id="navBarContainer"></div>
</header>
<!-- Page Content -->
<section class="container">
    <article class="row flex-row">
        <!--chat window-->
        <section class="col-xs-9">
            <div class="panel panel-default flex-col">
                <div class="panel-heading">Messages</div>
                <div class="panel-body flex-grow">
                    <ul class="list-group" id="chatMessagesList">
                        <li class="list-group-item">Welcome to our chat!</li>
                    </ul>
                </div>
                <div class="panel-footer">
                    <div class="input-group">
                        <input id="chatMessageInput" type="text" class="form-control"
                               placeholder="Type your message here">
                            <span class="input-group-btn">
                            <button id="chatSendMessageButton" class="btn btn-default" type="button">Send!</button>
                            </span>
                    </div>
                </div>
            </div>
        </section>

        <!--online users list-->
        <section class="col-xs-3">
            <div class="panel panel-default">
                <div class="panel-heading">Members</div>
                <div class="panel-body">
                    <ul>
                        <li>user 1</li>
                        <li>user 2</li>
                    </ul>
                </div>
            </div>

        </section>
    </article>
</section>
<!-- /.container -->

</body>
<script>
    //render nav-bar
    NavigationBar.renderIn("navBarContainer");

    /** connect to server socket*/
    var socket = io();

    /** get actual token from session storage*/
    var token = TokenHandler.getToken();

    /** subscribe on "connect" event*/
    socket.on('connect', function(){
        //try to authenticate
        socket.emit('authentication',token);

        /** if server unauthorized event*/
        socket.on('unauthorized',function(msg){
            console.log("socket.io unauthorized event: %s", msg);
            //TODO handle unauthorized user event
        });
    });

    //FIXME rebase this into connection event
    /** send message to server, add this message to list if server received it*/
    var sendMessageButton = $('#chatSendMessageButton');
    sendMessageButton.click(function (serverResponseData) {
        socket.emit('chat message', sendMessageButton.val());
        sendMessageButton.val('');
        //console.log(serverResponseData);
        return false;
    });

    /** add message to page*/
    socket.on('chat message created', function (msg) {
        $('#chatMessagesList').append(
                $('<li>', {class: "list-group-item"}).append(
                        $('<p>').append($('<strong>').text(TokenHandler.getUserProfile().login + ": "), msg)
                )
        );
    });
</script>
</html>